#!/usr/bin/perl

use strict;
use warnings;

BEGIN {
    my $dir = $ENV{'TEST_ROOT'}||'.';
    $ENV{'TEST_ROOT'} = $dir;
}

use lib "$ENV{'TEST_ROOT'}/perl-lib";

use BritneyTest;

my ($britney, $TESTSET, $RUNDIR) = @ARGV;

my @tests;
my $failed = 0;

die "Usage: $0 <britney> <testset> <rundir>"
    unless $britney && $TESTSET && $RUNDIR;

mkdir $RUNDIR, 0777 or die "mkdir $RUNDIR: $!\n";
opendir my $dd, $TESTSET or die "opendir $TESTSET: $!\n";
@tests = grep { !/^\./o } readdir $dd;
close $dd;

foreach my $t (@tests) {
    my $bt = BritneyTest->new ({}, "$RUNDIR/$t", "$TESTSET/$t");
    print "Running $t...";
    $bt->setup;
    if ($bt->run ($britney)) {
        print "done\n";
    } else {
        print "FAILED\n";
        $failed++;
    }
}

print "\nSummery:\n";
print 'Ran ' . scalar (@tests) . " tests\n";
print "Failed tests: $failed\n";
exit $failed ? 1 : 0;
